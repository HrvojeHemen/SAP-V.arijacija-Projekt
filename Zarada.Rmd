---
title: "NadamSeFInal"
author: "Jura"
date: "1/11/2022"
output: pdf_document
---

```{r setup, include=FALSE}


imdb <- read.csv(file = 'IMDB.csv')
ogimdb <- imdb
library(tidyr)

```




Možemo li temeljem danih varijabli predvidjeti zaradu filmova?
Trebamo provjeriti postoji li veza između ulaznih varijabli (regresora) i izlazne varijable (reakcije) koja je u našem slučaju zarada(gross) filma.
Za to ćemo koristiti linearnu regresiju. Želimo saznati koliko su te veze jake, koje ulazne varijable najviše utječu na zaradu, te vidjeti možemo li predvidjeti zaradu na temelju nekih ulaznih varijabli i s kojom točnošću.
Tražimo sve varijable koje bi mogle utjecati na zaradu filma, prvo bez uklanjanja NA vrijednosti i stršečih vrijendosti.
Zarada je prikazana u milijunima dolara.
Moramom uzeti u obzir da nisu sve varijable poznate pri izlasku novog filma.
Prvo ćemo ispitati utjecaj sljedećih varijabli:
- budžet (budget)
- trajanje filma (duration)
- godina izlaska filma (title_year)


```{r scatter plots}

plot(imdb$budget,imdb$gross/1000000) 


plot(imdb$duration,imdb$gross/1000000)


plot(imdb$title_year,imdb$gross/1000000)


```
Utjecaj svake od varijabli na zaradu prikazali smo pomoću scatter plot-a.
Vidimo da u dosta slučajeva postoje stršeće vrijednosti i NA vrijednosti zbog kojih je teže jasno vidjeti odnos varijabli.
Radi preglednosti ukloniti ćemo NA vrijednosti i ponoviti postupak.


```{r}

imdb <- imdb[!is.na(imdb$gross),]
imdb1 <- imdb[!is.na(imdb$budget),]
imdb2 <- imdb[!is.na(imdb$duration),]
imdb3 <- imdb[!is.na(imdb$title_year),]


```

```{r scatter plots}

plot(imdb1$budget,imdb1$gross/1000000) 


plot(imdb2$duration,imdb2$gross/1000000)


plot(imdb3$title_year,imdb3$gross/1000000)


```
Pošto ne vidimo preveliku promjenu, ukloniti ćemo i stršeće vrijednosti.

```{r}


outliersgross <- boxplot(imdb1$gross, plot=FALSE)$out
imdbh1 <- imdb1[-which(imdb1$gross %in% outliersgross),]

outliersgross <- boxplot(imdb2$gross, plot=FALSE)$out
imdbh2 <- imdb2[-which(imdb2$gross %in% outliersgross),]

outliersgross <- boxplot(imdb3$gross, plot=FALSE)$out
imdbh3 <- imdb3[-which(imdb3$gross %in% outliersgross),]

outliersbudget <- boxplot(imdbh1$budget, plot=FALSE)$out
imdb11 <- imdbh1[-which(imdbh1$budget %in% outliersbudget),]

outliersdur <- boxplot(imdbh2$duration, plot=FALSE)$out
imdb22<- imdbh2[-which(imdbh2$duration %in% outliersdur),]

outliersty <- boxplot(imdbh3$title_year, plot=FALSE)$out
imdb33 <- imdbh3[-which(imdbh3$title_year %in% outliersty),]

```


```{r scatter plots}

plot(imdb11$budget,imdb11$gross/1000000) 


plot(imdb22$duration,imdb22$gross/1000000)


plot(imdb33$title_year,imdb33$gross/1000000)


```
Primjećujemo da niti jedna od ulaznih varijabli nema jako veliku povezanost, ali npr. budget pokazuje određenu povezanost.

Sada ćemo na dijagrame dodati pravce linearne regresije kako bismo bolje vidjeli efekte varijabli na zaradu.


```{r jednostavna regresija}

fit.budget = lm(gross~budget,data=imdb11) 

fit.dur = lm(gross~duration,data=imdb22)


fit.ty = lm(gross~title_year,data=imdb33)


plot(imdb11$budget,imdb11$gross) 
lines(imdb11$budget,fit.budget$fitted.values,col='red') 

plot(imdb22$duration,imdb22$gross)
lines(imdb22$duration,fit.dur$fitted.values,col='red')


plot(imdb33$title_year,imdb33$gross)
lines(imdb33$title_year,fit.ty$fitted.values,col='red')


```
Sada bolje vidimo utjecaje na zaradu, budget ima najveći utjecaj što vidimo po nagibu pravca linearne regresije.

Sada ćemo provjeriti normalnost reziduala za svaki model pomoću kvantil-kvantil plota.


```{r}

selected.model = fit.budget

qqnorm(rstandard(selected.model))
qqline(rstandard(selected.model))


selected.model = fit.duration

qqnorm(rstandard(selected.model))
qqline(rstandard(selected.model))


selected.model = fit.ty

qqnorm(rstandard(selected.model))
qqline(rstandard(selected.model))


```

Distribucije donekle nalikuju na normalnu razdiobu, no neke krivulje su malo previše zakrivljene.
Pokušat ćemo to riješiti kasnije ddoavanjem drugih varijabli u model te dodavanjem interakcijskih ili polinomijalnih članova.

Pogledat ćemo mjere kvalitete prilagodbe modela podatcima.

```{r analiza procijenjenih modela}

summary(fit.budget)

summary(fit.duration)

summary(fit.ty)


```

Za svaki od modela možemo vidjeti interceot i slope, pomoću koji možemo procijeniti zaradu za bilo koju vrijednost ulazne varijable.


Primjećujemo da nisu svi modeli jednako kvalitetni. Vidimo da najveći utjecaj ima budget kao što smo i pretpostavili prije, to se očituje najvećim vrijednostima R^2. Vidimo da duration nema utjecaj kao budget ali ima određen značaj, dok za title_year vidimo da nema gotovo nikakav utjecaj (R^2 je skoro 0). 

Pogledajmo i Pearsonov keoficijent korelacije za sljedeće 3 varijable:

```{r korelacijski koeficijent}


cor(imdb11$budget,imdb11$gross)

cor(imdb22$duration,imdb22$gross)

cor(imdb33$title_year,imdb33$gross)
```
On dodatno potvrđuje veći utjecaj nekih varijabli.


Sada ćemo napraviti procjenu modela višestruke regresije. Prije procjene modela višestruke regresije moramo provjeriti da nam varijable nisu međusobno previše korelirane.

```{r cor}

imdbcor <- imdb[!is.na(imdb$gross),]
imdbcor <- imdbcor[!is.na(imdbcor$budget),]
imdbcor <- imdbcor[!is.na(imdbcor$duration),]
imdbcor <- imdbcor[!is.na(imdbcor$title_year),]

cor(cbind(imdbcor$budget,imdbcor$duration,imdbcor$title_year)) 

```
Vidimo da nam varijable nisu previše korelirane i možemo procijeniti model.

```{r visestruka regresija}
fit.multi = lm(gross ~ budget + duration + title_year, imdb11)
summary(fit.multi)

```
Vidimo da nam ovaj model nije mnogo bolji nego onaj koji sadrži samo buget. Zato ćemo radi jednostavnosti nastaviti s modelom koji sadrži samo budget.

Sada ćemo probati poboljšati model dodavajući kategorijske varijable.
Kategorijske varijable koje ćemo uzeti u obzir su:
- color
- language
- country
- content_rating
- aspect_ratio

```{r}

fit.multi.1 = lm(gross ~ budget + country , imdb11)
summary(fit.multi.1)



```

Dodavanjem varijable country model nam se poboljšava, ali u stupcu country se pojavljuje jako puno država, što bi nam zakompliciralo model, a i unos podataka pri procjeni zarade za novi film.
Pogledajmo koje sve vrijednosti može poprimiti stupac country.

```{r}
table(imdb11['country'])
```
Vidimo da ima uvjerljivo najviše američkih filmova, zato ćemo zbog jednostavnosti zamijeniti sve ostale države s OtherCountry.

```{r}
imdbcou = imdb11
imdbcou$country[imdbcou$country!="USA"]<-"OtherCountry"
table(imdbcou['country'])
```
Nakon zamjene isprobajmo novi model:

```{r}

fit.multi.2 = lm(gross ~ budget + country, imdbcou)
summary(fit.multi.2)



```
Model je gotovo jednako dobar što možemo vidjeti po ako usporedimo vrijednosti Adjusted R-squared (prije 0.2677, sada 0.2667).

Isprobajmo sada dodati još neke kategorijske varijable u naš model.



```{r}

fit.multi.3 = lm(gross ~ budget + country + color, imdbcou)
summary(fit.multi.3)

```
Dodavanjem varijable color nismo znatno poboljšali model, zato ćemo odbaciti color.

Prije dodavanja varijable language u model, pogledajmo koje sve vrijednosti postoje u tom stupcu.

```{r}
table(imdbcou['language'])
```
Engleski je očekivano najčešći jezik, zato ćemo sve ostale zamijeniti s OtherLanguage.

```{r}
imdblan = imdbcou
imdblan$language[imdblan$language!="English"]<-"OtherLanguage"
table(imdblan['language'])
```
```{r}

fit.multi.lan = lm(gross ~ budget + country + language, imdblan)
summary(fit.multi.lan)

```
Ponovno ne vidimo bitno poboljšanje u modelu, ponovit ćemo postupak za ostale kategorijske varijable, kako bismo pronašli najbolji model.

```{r}
table(imdbcou['content_rating'])
```
Mijenjamo sve vrijednosti osim PG, PG-13 i R u OtherRating.

```{r}
imdbcr = imdblan
imdbcr$content_rating[imdbcr$content_rating!="R" & imdbcr$content_rating!="PG-13" & imdbcr$content_rating!="PG"]<-"OtherRating"
table(imdbcr['content_rating'])
```
```{r}

fit.multi.cr = lm(gross ~ budget + country + content_rating, imdbcr)
summary(fit.multi.cr)

```
Niti dodavanje content_rating-a nam značajno ne poboljšava model.

```{r}
table(imdbcr['aspect_ratio'])
```
Zamijenimo sve vrijednosti aspect_ratio osim 1.85 i 2.35 s OtherRatio.

```{r}
imdbar = imdbcr
imdbar$aspect_ratio[imdbar$aspect_ratio!="1.85" & imdbar$aspect_ratio!="2.35"]<-"OtherRatio"
table(imdbar['aspect_ratio'])
```
```{r}

fit.multi.ar = lm(gross ~ budget + country + aspect_ratio, imdbar)
summary(fit.multi.ar)

```
Niti ovaj model nije bolji od modela koji samo sadrži budget i country.

Sada ćemo još pokušati transformirati neke varijable i približiti distribuciju reziduala normalnoj distribuciji.

```{r}
library("SciViews")
fit.multi.exp = lm(gross ~ budget + country + log(budget), imdbcou)
summary(fit.multi.exp)



```
Primijenili smo transformaciju log(budget) i time smo malo poboljšali model.
Pogledajmo sada distribuciju reziduala.

```{r}
selected.model = fit.multi.exp
hist((selected.model$residuals))
hist(rstandard(selected.model))
qqnorm(rstandard(selected.model))
qqline(rstandard(selected.model))
```
Uklonit ćemo još stršećih vrijednosti kako bismo distribuciju reziduala još više približili normalnoj-



```{r}
nrow(imdbar)
outliers00 <- boxplot(imdbar$gross, plot=FALSE)$out
imdbtry <- imdbar[-which(imdbar$gross %in% outliers00),]

outliers01 <- boxplot(imdbtry$budget, plot=FALSE)$out
imdbtry <- imdbtry[-which(imdbtry$budget %in% outliers01),]

outliers02 <- boxplot(imdbtry$gross, plot=FALSE)$out
imdbtry <- imdbtry[-which(imdbtry$gross %in% outliers02),]

outliers03 <- boxplot(imdbtry$budget, plot=FALSE)$out
imdbtry <- imdbtry[-which(imdbtry$budget %in% outliers03),]

outliers04 <- boxplot(imdbtry$gross, plot=FALSE)$out
imdbtry <- imdbtry[-which(imdbtry$gross %in% outliers04),]

# outliers05 <- boxplot(imdbtry$budget, plot=FALSE)$out
# imdbtry <- imdbtry[-which(imdbtry$budget %in% outliers05),]

outliers05 <- boxplot(imdbtry$gross, plot=FALSE)$out
imdbtry <- imdbtry[-which(imdbtry$gross %in% outliers05),]

outliers06 <- boxplot(imdbtry$gross, plot=FALSE)$out
imdbtry <- imdbtry[-which(imdbtry$gross %in% outliers06),]

outliers07 <- boxplot(imdbtry$gross, plot=FALSE)$out
imdbtry <- imdbtry[-which(imdbtry$gross %in% outliers07),]

nrow(imdbtry)

fit.multi.x = lm(gross ~ budget + country + log(budget), imdbtry)
summary(fit.multi.x)

selected.model = fit.multi.x
hist((selected.model$residuals))
hist(rstandard(selected.model))
qqnorm(rstandard(selected.model))
qqline(rstandard(selected.model))



```
Sada je distribucija nešto bliža normalnoj

Pogledajmo sada naš model.

```{r}

fit.multi.x = lm(gross ~ budget + country + log(budget), imdbtry)
summary(fit.multi.x)

```
Na temelju ovog modela pokušat ćemo predvidjeti zaradu novog filma.
Naš model sadržava relevantne varijable koje objašnjavaju oko 26% varijance zarade filma. 
Predviđanjem zarade novog filma vidjet je li tih 26% "dovoljna" vrijednost R^2.

Pošto je ovo stariji dataset, nekih filmova koji su u međuvremenu izašli nema (zadnja godina je 2016), pa na njima možemo ocijeniti model, ali isprobati ćemo i za neke filmove koji nisu ni sada izašli.

1)No time to die

```{r}

input_var <- data.frame(budget = 300000000, country = "USA") 
linear_model = fit.multi.x
predict(linear_model, newdata = input_var,interval = "confidence")
```
Rezultat koji smo dobili je interval pouzdanosti (95%) i fit predviđena vrijednost.
Film No time to die je zaradio oko 500 milijuna dolara, što niti blizu ne pada u naš interval pouzdanosti.

Isprobajmo sad s filmom koji ima manji budget.

2) Nobody

```{r}

input_var <- data.frame(budget = 16000000, country = "USA") 
linear_model = fit.multi.x
predict(linear_model, newdata = input_var,interval = "confidence")
```
Nobody je zapravo zaradio oko 40 milijuna, što opet nije blizu našoj procjeni.

Pokušat ćemo sada s filmom koji nije američki.

3) The Battle at Lake Changjin

Ovo je kineski film s dosta velikim budžetom.

```{r}

input_var <- data.frame(budget = 200000000, country = "OtherCountry") 
linear_model = fit.multi.x
predict(linear_model, newdata = input_var,interval = "confidence")
```
Prava zarada filma je oko 700-800 milijuna, naš model je opet puno pogriješio.

Sada ćemo probati još probati predvidjeti zaradu nekih filmova koji još nisu izašli.

4) The Batman

```{r}

input_var <- data.frame(budget = 100000000, country = "USA") 
linear_model = fit.multi.x
predict(linear_model, newdata = input_var,interval = "confidence")
```

5) Spiderman: Across the Spiderverse

```{r}

input_var <- data.frame(budget = 90000000, country = "USA") 
linear_model = fit.multi.x
predict(linear_model, newdata = input_var,interval = "confidence")
```
Zaključujemo da naš model nije dobar za kvalitetnu procjenu zarade novog filma, trebao bi nam model s većim R^2. Takav bolji model bismo dobili dodavanjem varijabli koje više utječu na zaradu, a te varijable nam često nisu dostupne prije samog izlaska filma ili su prekomplicirane za napraviti model s njima (npr glumci u filmu sigurno imaju veliki utjecaj na zaradu ali pošto ima jako puno glumaca, teže je napraviti model). Osim toga treba uzeti u obzir da na zaradu utječu i druge varijable osim ovih koje su prikazane u ovom datasetu.


